---
title: "IPEDS FALL COLLECTION SURVEYS"
#date: "Updated: `r format(Sys.Date(), '%d %B %Y')`"
output:
  html_document:
    toc: yes
    toc_float:
      collapsed: true
      smooth_scroll: false
    code_folding: hide
    df_print: paged
    theme: readable
    always_allow_html: true
  word_document:
    toc: yes
  pdf_document:
    toc: yes
editor_options:
  markdown:
    wrap: 72
---
Started: 9 September 2024

Updated: `r format(Sys.Date(), '%d %B %Y')`

This notebook makes it easier to check for accuracy for future the IPEDS Data Reporting Process.. Simply download the CSV files (except for **ANN114D** - it needs to be in Excel because their CSV is meaninglessly formatted) into the marked folders in **Y:/Reporting/IPEDS/2024-2025/Fall Collection Surveys**, then `knit` the notebook.

```{r,warning=F,message=F,echo=F}
knitr::opts_chunk$set(echo = TRUE,warning = F,message = F)

#source("C:/Users/alam/Documents/R-Work/RSQL_login_RJ.R")
source("Y:/Reporting/_Code_/R_SQL_Oracle_connection.R")
```

# 12-Month Enrollment

## **Part A**

• The Commission on Higher Education (CHE) will pre-populate the data for this survey.

• PART A – The following EDSS reports are used to verify the data:

Use report IPD309 for the tables in Part A titled 12-month Unduplicated Count by Race/Ethnicity and Gender - Full-time/ Part-time Undergraduate Students

  ▪ Use Academic Year 2023

```{r echo=F}
#Combine AY - Academic Year into one DF
# IPD309_path = "Y:/Reporting/IPEDS/2024-2025/Fall Collection Surveys - AHL/IPD309"

#function to move Excel NAs
move_to_top= function(column) {
  non_na_values = column[!is.na(column)]
  c(non_na_values, rep(NA, length(column) - length(non_na_values)))
}

#create function to create year

create_year = function(file) {
  str_extract(basename(file), "\\d{4}")
}

IPD309_path = "IPD309"

IPD309_pattern = "\\d{4} - EDSS_ST_IPD309_Part_A_12_Month_Unduplicated_Count_by_Ethnicity_Gender.csv"

IPD309_files = list.files(IPD309_path, full.names = TRUE)

IPD309_matching_files = IPD309_files[grepl(IPD309_pattern, IPD309_files)]

#remove hashtag on data$YEAR once there's data
IPD309_data_list = lapply(IPD309_matching_files, function(file) {
  data=read.csv(file, stringsAsFactors = F,colClasses = "character")
  data$YEAR= create_year(file)
  data
})

IPD309_DF= bind_rows(IPD309_data_list) %>% 
  data.frame()
```


```{r}

IPD309 = IPD309_DF %>% 
  rename(enrollment_status=textbox21,
         sex = textbox18,
         total_degree.certificate_seeking=textbox32,
         total_undergraduates_students=textbox46,
         Continuing=Other_degree_certificate_seeking) %>% 
  select(2:10,YEAR) %>% 
  mutate(enrollment_status = paste0(sub("-(.*)", "", enrollment_status),"-time")) %>% 
  mutate_all(~ str_remove_all(., ",")) %>% 
  mutate_at(4:10,as.numeric)
```

```{r}

#function for summary row and col
IPD309_bottom_summary_row = function(df) {
  df %>% 
    ungroup() %>% 
  add_row(First_time_1=sum(.$First_time_1),
          Transfers = sum(.$Transfers),
          Continuing = sum(.$Continuing),
          total_degree.certificate_seeking=sum(.$total_degree.certificate_seeking),                           Non_degree_certificate_seeking= sum(.$Non_degree_certificate_seeking),                         total_undergraduates_students=sum(.$total_undergraduates_students)) %>% 
  mutate(Total=First_time_1 + Transfers + Continuing + total_degree.certificate_seeking +Non_degree_certificate_seeking+ total_undergraduates_students)
}

#choose YEAR as 2023
IPD309 = IPD309 %>% 
  filter(YEAR=="2023")
```

### by Race/Ethnicity and Gender - Full-time Undergraduate students

#### Men
```{r}
IPD309%>% 
  filter(sex=="Men",
         enrollment_status=="Full-time") %>% 
    IPD309_bottom_summary_row()%>% 
  datatable()
```

#### Women
```{r}
IPD309%>% 
  filter(sex=="Women",
         enrollment_status=="Full-time") %>% 
    IPD309_bottom_summary_row()%>% 
  datatable()
```

### by Race/Ethnicity and Gender - Part-time Undergraduate students

#### Men
```{r}
IPD309%>% 
  filter(sex=="Men",
         enrollment_status=="Part-time") %>% 
    IPD309_bottom_summary_row()%>% 
  datatable()

```

#### Women
```{r}
IPD309%>% 
  filter(sex=="Women",
         enrollment_status=="Part-time") %>% 
    IPD309_bottom_summary_row()%>% 
  datatable()
```

### by Race/Ethnicity and Gender - Undergraduate Student Total

#### Men

```{r}
IPD309 %>% 
  filter(sex=="Men") %>% 
  group_by(enrollment_status,race_literal) %>% 
  summarise(total_undergraduates_students=sum(total_undergraduates_students),.groups = 'drop') %>%
  pivot_wider(names_from = enrollment_status,
              values_from = total_undergraduates_students) %>% 
  mutate(Total = rowSums(across(c(`Full-time`, `Part-time`)),na.rm=T)) %>%  
  ungroup() %>% 
  add_row(`Full-time`=sum(.$`Full-time`,na.rm = T),
          `Part-time`=sum(.$`Part-time`,na.rm = T),
           Total=sum(.$Total,na.rm = T))
```

#### Women
```{r}
#took 20x to iterate
IPD309 %>% 
  filter(sex=="Women") %>% 
  group_by(enrollment_status,race_literal) %>% 
  summarise(total_undergraduates_students=sum(total_undergraduates_students),.groups = 'drop') %>%
  pivot_wider(names_from = enrollment_status,
              values_from = total_undergraduates_students) %>% 
  mutate(Total = rowSums(across(c(`Full-time`, `Part-time`)),na.rm=T)) %>%  
  ungroup() %>% 
  add_row(`Full-time`=sum(.$`Full-time`,na.rm = T),
          `Part-time`=sum(.$`Part-time`,na.rm = T),
           Total=sum(.$Total,na.rm = T))

```

#### Grand Total (men + women)
```{r}
IPD309 %>% 
  group_by(enrollment_status) %>% 
  summarise(total_undergraduates_students=sum(total_undergraduates_students)) %>% 
  pivot_wider(names_from = enrollment_status,
              values_from = total_undergraduates_students) %>% 
  mutate(Total = `Full-time` + `Part-time`)
```


### by Gender Unknown or Another Gender than Provided Categories

#### Grand total
```{r}
IPD309 %>% 
  group_by(YEAR,sex) %>% 
  select(total_undergraduates_students) %>% 
  summarise(total_undergraduates_students=sum(total_undergraduates_students),.groups = 'drop') %>% 
  mutate(percent= total_undergraduates_students/sum(total_undergraduates_students)) %>% 
  add_row(total_undergraduates_students=sum(.$total_undergraduates_students),
          percent=sum(.$percent))
```

##### Download IPD309
```{r}
download_this(IPD309,output_name =  "IPD309",output_extension ='.xlsx')
```

### by Distance Education Status

Use Report IPD307A to complete the table titled 12-month Unduplicated Count - Distance Education Status

  ▪ Use Academic Year 2023

```{r}
#import
IPD307A_path = "IPD307A"

IPD307A_pattern = "\\d{4} - EDSS_ST_IPD307A_cers_IPEDS_Part_A_Enr_survey_by_Distance_Learning.csv"

IPD307A_files = list.files(IPD307A_path, full.names = TRUE)

IPD307A_matching_files = IPD307A_files[grepl(IPD307A_pattern, IPD307A_files)]

IPD307A_data_list = lapply(IPD307A_matching_files, function(file) {
  data=read.csv(file)
  data$YEAR= create_year(file)
  data
})

IPD307A_DF= bind_rows(IPD307A_data_list) %>% 
  data.frame()

#remove commas to change character to numeric
IPD307A = IPD307A_DF %>%
   mutate_all(~gsub(",", "", .)) %>% 
  rename(degree_seeking = degree1,number_enrolled=DL_survey,nondegree_seeking=NonDegree, total_enrolled=Textbox22) %>% 
  select(YEAR,1:5) %>%  
  mutate_at(vars(degree_seeking,number_enrolled,nondegree_seeking),as.numeric)

```


```{r}
#bottom summary row IPD307A
IPD307A_bottom_summary_row = function(df) {
    df %>% 
    ungroup() %>% 
    add_row(degree_seeking= sum(.$degree_seeking),
              nondegree_seeking = sum(.$nondegree_seeking),
              number_enrolled=sum(.$number_enrolled)) %>% 
            mutate(Total=degree_seeking + nondegree_seeking + number_enrolled)
}
```


```{r}
#do filter() after bind_rows to show only the YEAR data desired
IPD307A %>% 
  filter(YEAR=="2023") %>% 
  group_by(DistLearnType) %>% 
  IPD307A_bottom_summary_row() %>% 
  datatable()
  
```

##### Download IPD307A
```{r}
download_this(IPD307A,output_name = "IPD307A",output_extension ='.xlsx')
```

## **Part B**
Instructional Activity

  ▪The CHE will pre-populate the data for this survey
  
  ▪Use ANN107 to verify the pre-populated values are correct.
  
  •Use Academic Year 2023
  
### by Instructional Activity
```{r}
#import
ANN107_path = "ANN107"

ANN107_pattern = "\\d{4} - EDSS_ST_ANN107_Annualized_Headcount By Gender_Race.csv"

ANN107_files = list.files(ANN107_path, full.names = TRUE)

ANN107_matching_files = ANN107_files[grepl(ANN107_pattern, ANN107_files)]

ANN107_data_list = lapply(ANN107_matching_files, function(file) {
  data=read.csv(file)
  data$YEAR= create_year(file)
  data
})

ANN107_DF= bind_rows(ANN107_data_list) %>% 
  data.frame()

ANN107 = ANN107_DF %>% 
  select(YEAR,gender=txt_gender_name,race=txt_race_name,headcount=Textbox18,FTE=textbox3,everything())
```

```{r}
ANN107_bottom_summary_row= function(df) {
  df %>% 
    add_row(headcount=sum(.$headcount),
            FTE=sum(.$FTE),
            credit_hours=sum(.$credit_hours)) %>% 
    mutate(Total = headcount + FTE + credit_hours)
  }

#bind with bottom summary rows function
ANN107 %>% 
  filter(YEAR=="2023") %>% 
  ANN107_bottom_summary_row() %>% 
  datatable()
```


##### Download ANN107
```{r}
download_this(ANN107,output_name = "ANN107",output_extension ='.xlsx')
```

## **Part C**
Unduplicated count of dual enrolled students

  ▪The CHE will pre-populate the data for this survey
  
  ▪Use ANN114D to verify the pre-populated values are correct.
  
  •Select 2023 for both dates and OPEN for the interval. This report is built to run multiple years but only the 2023 year is necessary for Part C validation.

```{r echo=F ,include=F}
#no data uploaded yet; use 2022 to build code for 2023

#download the Excel not the CSV version. CSV makes no sense whatsoever

library(readxl)

ANN114D_path = "ANN114D"

ANN114D_pattern = "\\d{4} - EDSS_ST_ANN115_Annualized_By_Dual_Enrollment_by_Gender_Race.xlsx"

ANN114D_files = list.files(ANN114D_path, full.names = TRUE)

ANN114D_matching_files = ANN114D_files[grepl(ANN114D_pattern, ANN114D_files)]

ANN114D_data_list = lapply(ANN114D_matching_files, function(file) {
  data=read_excel(file)
  data$YEAR= create_year(file)
  data
})

ANN114D_DF= bind_rows(ANN114D_data_list)
```

```{r}
#move data up function
# Remove NAs and keep the non-NA values
# Pad the remaining column with NAs at the bottom
move_to_top= function(column) {
  non_na_values = column[!is.na(column)]
  c(non_na_values, rep(NA, length(column) - length(non_na_values)))
}

ANN114 = data.frame(lapply(ANN114D_DF, move_to_top))
```

```{r}
ANN114.1=ANN114 %>% 
  select(5:9,-7)

ANN114.2 = ANN114.1 %>% 
  drop_na()
```


```{r}
ANN114.2 %>% 
  datatable()
```

##### Download ANN114D
```{r}
download_this(ANN114.2,output_name = "ANN114D",output_extension ='.xlsx')
```

## **Summary**
### by Enrollment Component Summary

#### Undergraduate Student Characteristics
##### Percent of undergrad students who are FEMALE
```{r}
IPD309 %>% 
  group_by(sex) %>% 
  summarise(headcount=sum(First_time_1 + Transfers + Continuing + Non_degree_certificate_seeking + total_degree.certificate_seeking))  %>% 
  mutate(percent= headcount/sum(headcount)) %>% 
  arrange(-percent) %>% 
  ungroup() %>% 
  add_row(headcount= sum(.$headcount),
          percent = sum(.$percent))

```

#### Percent of undergrad students who are FULL-TIME
```{r}
IPD309 %>% 
  filter(YEAR=="2023") %>% 
  group_by(enrollment_status) %>% 
  summarise(headcount=sum(total_undergraduates_students))  %>% 
  mutate(percent= headcount/sum(headcount)) %>% 
  ungroup() %>% 
  add_row(headcount= sum(.$headcount),
          percent = sum(.$percent))
```

#### Percent of undergrad students who are enrolled exclusively in distance education courses
```{r}
IPD307A %>% 
  filter(YEAR=="2023") %>% 
  group_by(DistLearnType) %>% 
  summarise(headcount=sum(number_enrolled))  %>% 
  mutate(percent= headcount/sum(headcount)) %>% 
  ungroup() %>% 
  add_row(headcount= sum(.$headcount),
          percent = sum(.$percent)) %>% 
  datatable()
```


#### Race/ethnicity by percent
```{r}
IPD309 %>% 
  group_by(race_literal) %>% 
  summarise(headcount=sum(total_undergraduates_students))  %>% 
  mutate(percent= headcount/sum(headcount)) %>% 
  ungroup() %>% 
  add_row(headcount= sum(.$headcount),
          percent = sum(.$percent))
```


# Completions
•The Commission on Higher Education (CHE) will pre-populate the data for this survey.

•Note: Completions should be reported using the 2020 CIP Codes.

•The following EDSS report is used to verify the data:

  o IPEDS105 – IPEDS CIP Detail Completions Report
  
  ▪Export to .xlsx or .csv (then save as .xlsx)
    
  ▪Use the Pivot Table function to produce the tables to fill in the required information.
    
  ▪Use 2023- 2024 Academic Year

```{r}
#import; make sure _path matches as IPD and not IPEDS

create_year1 = function(file) {
  str_extract(basename(file), "\\d{4}_\\d{4}")
}

IPD105_path = "IPD105"

IPD105_pattern = "\\d{4}_\\d{4} - EDSS_ST_IPD105_annualized_completions_report_ipeds_detail.csv"

IPD105_files = list.files(IPD105_path, full.names = TRUE)

IPD105_matching_files = IPD105_files[grepl(IPD105_pattern, IPD105_files)]

IPD105_data_list = lapply(IPD105_matching_files, function(file) {
  data = read.csv(file)
  data$YEAR =create_year1(file)
  data
})

IPD105_DF = bind_rows(IPD105_data_list) %>%
  data.frame()
```

```{r}
IPD105= IPD105_DF %>% 
  filter(YEAR=="2023_2024") %>% 
  mutate(AGE = case_when(nbr_student_age < 18 ~ "Under 18",
                         nbr_student_age <= 24 ~ "18-24",
                         nbr_student_age <= 39 ~ "25-39",
                         nbr_student_age >= 40 ~ "40 and Above",
                         TRUE ~ "Age Unknown",
                         FALSE ~ "AGEALERT")) %>% 
  mutate(txt_program_code = as.character(txt_program_code))
```

## Gender by Race
```{r}
IPD105 %>% 
  distinct(YEAR,Student_ID1,.keep_all = T) %>% 
  group_by(txt_gender_name,race_ethnicity) %>% 
  summarise(HEADCOUNT=n())%>% 
   pivot_wider(names_from = txt_gender_name,values_from = HEADCOUNT) %>% 
  bind_rows(summarise(.,across(where(is.numeric),sum,na.rm=T))) %>% 
  mutate(Total = rowSums(across(where(is.numeric)), na.rm =T))
```


## By Gender
```{r}
IPD105 %>% 
  distinct(YEAR,Student_ID1,.keep_all = T) %>% 
  group_by(YEAR,txt_gender_name) %>% 
  summarise(HEADCOUNT=n())%>% 
  #pivot_wider(names_from = YEAR,values_from = HEADCOUNT) %>% 
  bind_rows(summarise(.,across(where(is.numeric),sum,na.rm=T)))
```

## By Race/Ethnicity
```{r}
IPD105 %>% 
  distinct(YEAR,Student_ID1,.keep_all = T) %>% 
  group_by(race_ethnicity) %>% 
  summarise(HEADCOUNT=n())%>% 
  bind_rows(summarise(.,across(where(is.numeric),sum,na.rm=T))) %>% 
  mutate(Total = rowSums(across(where(is.numeric)), na.rm =T))
```


## By Age
```{r}
IPD105 %>% 
  distinct(YEAR,Student_ID1,.keep_all = T) %>% 
  group_by(AGE) %>% 
  arrange(desc(AGE)) %>% 
  summarise(HEADCOUNT=n()) %>% 
  bind_rows(summarise(.,across(where(is.numeric),sum,na.rm=T)))

```


## Completions by CIP
### By Men
```{r}
CIP_men = IPD105 %>%
  filter(txt_gender_name=="Male") %>% 
  group_by(race_ethnicity,txt_program_name,txt_program_code) %>% 
  summarise(HEADCOUNT= n()) %>% 
  pivot_wider(names_from = race_ethnicity,values_from = HEADCOUNT) %>% 
  mutate(Total = rowSums(across(where(is.numeric)), na.rm = TRUE)) %>%
  ungroup() %>% 
  bind_rows(summarise(.,across(where(is.numeric),sum,na.rm=T))) %>% 
  arrange(as.numeric(txt_program_code))%>% 
  select(txt_program_code,Total,everything())

CIP_men %>% 
  datatable()
```

### By Women
```{r}
CIP_women = IPD105 %>%
  filter(txt_gender_name=="Female") %>% 
  group_by(race_ethnicity,txt_program_name,txt_program_code) %>% 
  summarise(HEADCOUNT= n()) %>% 
  pivot_wider(names_from = race_ethnicity,values_from = HEADCOUNT) %>% 
  mutate(Total = rowSums(across(where(is.numeric)), na.rm = TRUE)) %>%
  ungroup() %>% 
  bind_rows(summarise(.,across(where(is.numeric),sum,na.rm=T))) %>% 
  arrange(as.numeric(txt_program_code)) %>% 
  select(txt_program_code,Total,everything())

CIP_women %>% 
  datatable()

```

Data in IPEDS are consistent with my numbers.


```{r echo=F, include=F}
#random letter generator; hide this chunk
random_letter= sample(letters)
random_letter2 = sample(LETTERS)
```

##### Download IPD105
```{r}
download_this(IPD105,output_name = "IPD105",output_extension ='.xlsx')
```


```{r include=FALSE}
#beep when done
if (require("beepr",quietly = T))
  beepr::beep(2)
```
